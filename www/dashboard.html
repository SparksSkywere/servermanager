<!DOCTYPE html>
<html>
<head>
    <title>Server Manager Dashboard</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <!-- Add Chart.js for statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>Server Manager</h2>
                <span id="username"></span>
            </div>
            <ul class="nav-links">
                <li class="active"><a href="#overview">Overview</a></li>
                <li><a href="#servers">Servers</a></li>
                <li><a href="#monitoring">Monitoring</a></li>
                <li><a href="#settings">Settings</a></li>
                <li id="adminButton" style="display: none;"><a href="admin.html">Administration</a></li>
                <li class="logout"><a href="#" onclick="logout()">Logout</a></li>
            </ul>
        </nav>

        <main class="content">
            <div class="header">
                <div class="header-title">
                    <h1>Dashboard Overview</h1>
                    <span id="last-update"></span>
                </div>
                <div class="header-actions">
                    <button class="btn" onclick="refreshAll()">Refresh</button>
                    <button class="btn btn-primary" onclick="location.href='create-server.html'">New Server</button>
                </div>
            </div>

            <!-- Statistics Overview -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon servers"></div>
                    <div class="stat-info">
                        <h3>Total Servers</h3>
                        <div class="stat-value" id="totalServers">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon running"></div>
                    <div class="stat-info">
                        <h3>Running</h3>
                        <div class="stat-value" id="runningServers">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon cpu"></div>
                    <div class="stat-info">
                        <h3>CPU Usage</h3>
                        <div class="stat-value" id="cpuUsage">0%</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon memory"></div>
                    <div class="stat-info">
                        <h3>Memory Usage</h3>
                        <div class="stat-value" id="memoryUsage">0%</div>
                    </div>
                </div>
            </div>

            <!-- Performance Charts -->
            <div class="charts-container">
                <div class="chart-card"></div>
                    <h3>System Performance</h3>
                    <canvas id="performanceChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Server Status Distribution</h3>
                    <canvas id="statusChart"></canvas>
                </div>
            </div>

            <!-- Server List -->
            <div class="server-management">
                <div class="card">
                    <div class="card-header">
                        <h2>Server Management</h2>
                        <div class="card-actions">
                            <select id="bulkAction">
                                <option value="">Bulk Actions...</option>
                                <option value="start">Start Selected</option>
                                <option value="stop">Stop Selected</option>
                                <option value="restart">Restart Selected</option>
                            </select>
                            <button class="btn" onclick="executeBulkAction()">Apply</button>
                        </div>
                    </div>
                    <div class="server-list" id="serverList">
                        <!-- Servers will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Activity Log -->
            <div class="activity-log">
                <h3>Recent Activity</h3>
                <div id="activityLog" class="log-container"></div>
            </div>
        </main>
    </div>

    <!-- Notification System -->
    <div id="notification" class="notification"></div>

    <script type="module">
        import { checkAuth, logout, isAdmin } from './js/auth.js';
        import { showNotification } from './js/utils.js';
        import API from './js/api.js';

        // Make functions globally available
        window.logout = logout;
        window.refreshAll = refreshDashboard;
        window.executeBulkAction = executeBulkAction;

        // Modified logout function
        async function logout() {
            sessionStorage.clear();
            window.location.replace('login.html');
        }

        // Performance chart initialization
        const perfCtx = document.getElementById('performanceChart').getContext('2d');
        const perfChart = new Chart(perfCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'CPU Usage',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }, {
                    label: 'Memory Usage',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    tension: 0.1
                }]
            }
        });

        // Status chart initialization
        const statusCtx = document.getElementById('statusChart').getContext('2d');
        const statusChart = new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: ['Running', 'Stopped', 'Error'],
                datasets: [{
                    data: [0, 0, 0],
                    backgroundColor: ['#4CAF50', '#FFA726', '#F44336']
                }]
            }
        });

        async function refreshDashboard() {
            try {
                const stats = await API.getSystemStats();
                updateDashboardStats(stats);
                
                const servers = await API.getServers();
                updateServerList(servers);
                updateCharts(stats, servers);
                
                document.getElementById('last-update').textContent = 
                    `Last updated: ${new Date().toLocaleTimeString()}`;
                
                showNotification('Dashboard updated successfully', 'success');
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        function updateDashboardStats(stats) {
            document.getElementById('totalServers').textContent = stats.totalServers;
            document.getElementById('runningServers').textContent = stats.runningServers;
            document.getElementById('cpuUsage').textContent = `${stats.cpuUsage.toFixed(1)}%`;
            document.getElementById('memoryUsage').textContent = `${stats.memoryUsage.toFixed(1)}%`;
        }

        function updateServerList(servers) {
            const serverList = document.getElementById('serverList');
            serverList.innerHTML = servers.map(server => `
                <div class="server-item ${server.status.toLowerCase()}">
                    <div class="server-info">
                        <input type="checkbox" name="serverSelect" value="${server.name}">
                        <h4>${server.name}</h4>
                        <span class="status">${server.status}</span>
                    </div>
                    <div class="server-stats">
                        <span>CPU: ${server.cpuUsage}%</span>
                        <span>Memory: ${server.memoryUsage}%</span>
                        <span>Uptime: ${formatUptime(server.uptime)}</span>
                    </div>
                    <div class="server-actions">
                        <button onclick="controlServer('start', '${server.name}')" 
                                ${server.status === 'Running' ? 'disabled' : ''}>Start</button>
                        <button onclick="controlServer('stop', '${server.name}')"
                                ${server.status === 'Stopped' ? 'disabled' : ''}>Stop</button>
                        <button onclick="controlServer('restart', '${server.name}')"
                                ${server.status === 'Stopped' ? 'disabled' : ''}>Restart</button>
                    </div>
                </div>
            `).join('');
        }

        function updateCharts(stats, servers) {
            // Update performance chart
            const now = new Date().toLocaleTimeString();
            perfChart.data.labels.push(now);
            perfChart.data.datasets[0].data.push(stats.cpuUsage);
            perfChart.data.datasets[1].data.push(stats.memoryUsage);
            
            // Keep only last 10 data points
            if (perfChart.data.labels.length > 10) {
                perfChart.data.labels.shift();
                perfChart.data.datasets.forEach(dataset => dataset.data.shift());
            }
            perfChart.update();

            // Update status chart
            const statusCounts = servers.reduce((acc, server) => {
                acc[server.status]++;
                return acc;
            }, { Running: 0, Stopped: 0, Error: 0 });

            statusChart.data.datasets[0].data = [
                statusCounts.Running,
                statusCounts.Stopped,
                statusCounts.Error
            ];
            statusChart.update();
        }

        function formatUptime(seconds) {
            if (!seconds) return 'N/A';
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${days}d ${hours}h ${minutes}m`;
        }

        // Add session verification
        document.addEventListener('DOMContentLoaded', async () => {
            if (!sessionStorage.getItem('auth_token')) {
                window.location.replace('login.html');
                return;
            }

            try {
                await checkAuth(); // Verify token is still valid
                const username = sessionStorage.getItem('username') || 'User';
                document.getElementById('username').textContent = username;
                
                const adminStatus = await isAdmin();
                console.log('Checking admin status:', adminStatus);
                
                if (adminStatus) {
                    console.log('Showing admin button');
                    document.getElementById('adminButton').style.display = 'block';
                } else {
                    console.log('User is not admin');
                }
                
                refreshDashboard();
                setInterval(refreshDashboard, 30000);
            } catch (error) {
                console.error('Authentication error:', error);
                sessionStorage.clear();
                window.location.replace('login.html');
            }
        });

        // Add periodic token verification
        setInterval(async () => {
            try {
                await checkAuth();
            } catch (error) {
                sessionStorage.clear();
                window.location.replace('login.html');
            }
        }, 60000); // Check every minute

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            const username = sessionStorage.getItem('username') || 'User';
            document.getElementById('username').textContent = username;
            
            // Check if user is admin and show admin button if true
            if (await isAdmin()) {
                document.getElementById('adminButton').style.display = 'block';
            }
            
            refreshDashboard();
            setInterval(refreshDashboard, 30000);
        });
    </script>
</body>
</html>
