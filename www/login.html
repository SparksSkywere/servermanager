<!DOCTYPE html>
<html>
<head>
    <title>Login - Server Manager</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/login.css">
    <script type="module" src="js/config.js"></script>
    <script type="module" src="js/api.js"></script>
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <h1>Server Manager</h1>
            <div id="error" class="error"></div>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="authType">Authentication Method:</label>
                    <select id="authType" required>
                        <option value="" disabled>Select authentication method...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="username">Username:</label>
                    <input type="text" id="username" required placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" required placeholder="Enter password">
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
                <div id="loading" class="loading-spinner" style="display: none;">Authenticating...</div>
            </form>
        </div>
    </div>

    <script>
        window.addEventListener('DOMContentLoaded', async () => {
            const select = document.getElementById('authType');
            const error = document.getElementById('error');
            
            try {
                const response = await API.getAuthMethods();
                const methods = await response.json();
                
                // Clear and disable select while loading
                select.innerHTML = '';
                select.disabled = true;
                
                if (!Array.isArray(methods) || methods.length === 0) {
                    console.error('No authentication methods returned');
                    throw new Error('No authentication methods available');
                }

                methods.forEach(method => {
                    const option = document.createElement('option');
                    option.value = method.type;
                    option.text = method.name;
                    if (method.isDefault) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                
                // Enable select after loading options
                select.disabled = false;
                error.textContent = '';
            } catch (err) {
                console.error('Error loading auth methods:', err);
                error.textContent = err.message;
                
                // Add fallback option for Local authentication
                select.innerHTML = '';
                const option = document.createElement('option');
                option.value = 'Local';
                option.text = 'Local Windows';
                option.selected = true;
                select.appendChild(option);
                select.disabled = false;
            }
        });

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const authType = document.getElementById('authType').value;
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');

            error.textContent = '';
            loading.style.display = 'block';

            try {
                const response = await API.login({ username, password, authType });
                const data = await response.json();
                sessionStorage.setItem('auth_token', data.token);
                sessionStorage.setItem('auth_type', authType);
                window.location.href = 'dashboard.html';
            } catch (error) {
                error.textContent = error.message;
            } finally {
                loading.style.display = 'none';
            }
        }
    </script>
</body>
</html>
